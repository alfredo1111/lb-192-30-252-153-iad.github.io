define(["require", "exports", "underscore", "q", "knockout", "../../Platform/Emulator/Authorization", "../../Platform/Hosted/Authorization", "../../Contracts/ViewModels", "../../Common/Constants", "../../Shared/Telemetry/TelemetryConstants", "../../AuthType", "../../Shared/DefaultExperienceUtility", "../Tabs/DocumentsTab", "../Tabs/ConflictsTab", "../Tabs/MongoDocumentsTab", "../Tabs/SettingsTab", "../Tabs/QueryTab", "../Tabs/MongoQueryTab", "../Tabs/QueryTablesTab", "../Tabs/GraphTab", "../Tabs/MongoShellTab", "./StoredProcedure", "./UserDefinedFunction", "./Trigger", "../Menus/ContextMenu", "../../Shared/Telemetry/TelemetryProcessor", "../../Utils/NotificationConsoleUtils", "../../Utils/OfferUtils", "../Menus/NotificationConsole/NotificationConsole", "../ContextMenuButtonFactory", "../../Common/Logger", "../../PlatformType"], function (require, exports, _, Q, ko, EmulatorAuthorization, HostedAuthorization, ViewModels, Constants, TelemetryConstants_1, AuthType_1, DefaultExperienceUtility_1, DocumentsTab, ConflictsTab_1, MongoDocumentsTab, SettingsTab, QueryTab, MongoQueryTab, QueryTablesTab_1, GraphTab, MongoShellTab, StoredProcedure, UserDefinedFunction, Trigger, ContextMenu, TelemetryProcessor_1, NotificationConsoleUtils_1, OfferUtils_1, NotificationConsole_1, ContextMenuButtonFactory_1, Logger_1, PlatformType_1) {
    "use strict";
    var DocumentDB = window.DocumentDB;
    var Collection = /** @class */ (function () {
        function Collection(container, database, data, quotaInfo, offer) {
            var _this = this;
            this.onKeyPress = function (source, event) {
                if (event.keyCode === Constants.KeyCodes.Space || event.keyCode === Constants.KeyCodes.Enter) {
                    _this.expandCollapseCollection();
                    return false;
                }
                return true;
            };
            this.onKeyDown = function (source, event) {
                if (event.key === "Delete") {
                    _this.onDeleteCollectionContextMenuClick(source, event);
                    return false;
                }
                if (event.key === "ArrowRight" && !_this.isCollectionExpanded()) {
                    _this.expandCollection();
                    return false;
                }
                if (event.key === "ArrowDown" && !_this.isCollectionExpanded()) {
                    _this.expandCollection();
                    return false;
                }
                if (event.key === "ArrowLeft" && _this.isCollectionExpanded()) {
                    _this.collapseCollection();
                    return false;
                }
                return true;
            };
            this.onMenuKeyDown = function (source, event) {
                if (event.key === "Escape") {
                    _this.contextMenu.hide(source, event);
                    return false;
                }
                return true;
            };
            this.onDocumentDBDocumentsKeyDown = function (source, event) {
                return true;
            };
            this.onDocumentDBDocumentsKeyPress = function (source, event) {
                if (event.keyCode === Constants.KeyCodes.Space || event.keyCode === Constants.KeyCodes.Enter) {
                    _this.onDocumentDBDocumentsClick();
                    return false;
                }
                return true;
            };
            this.onConflictsKeyPress = function (source, event) {
                if (event.keyCode === Constants.KeyCodes.Space || event.keyCode === Constants.KeyCodes.Enter) {
                    _this.onConflictsClick();
                    return false;
                }
                return true;
            };
            this.onMongoDBDocumentsKeyDown = function (source, event) {
                return true;
            };
            this.onMongoDBDocumentsKeyPress = function (source, event) {
                if (event.keyCode === Constants.KeyCodes.Space || event.keyCode === Constants.KeyCodes.Enter) {
                    _this.onMongoDBDocumentsClick();
                    return false;
                }
                return true;
            };
            this.onSettingsKeyDown = function (source, event) {
                return true;
            };
            this.onSettingsKeyPress = function (source, event) {
                if (event.keyCode === Constants.KeyCodes.Space || event.keyCode === Constants.KeyCodes.Enter) {
                    _this.onSettingsClick();
                    return false;
                }
                return true;
            };
            this.onStoredProceduresKeyDown = function (source, event) {
                if (event.key === "ArrowRight" && !_this.isStoredProceduresExpanded()) {
                    _this.expandStoredProcedures();
                    return false;
                }
                if (event.key === "ArrowDown" && !_this.isStoredProceduresExpanded()) {
                    _this.expandStoredProcedures();
                    return false;
                }
                if (event.key === "ArrowLeft" && _this.isStoredProceduresExpanded()) {
                    _this.collapseStoredProcedures();
                    return false;
                }
                return true;
            };
            this.onStoredProceduresKeyPress = function (source, event) {
                if (event.keyCode === Constants.KeyCodes.Space || event.keyCode === Constants.KeyCodes.Enter) {
                    _this.expandCollapseStoredProcedures();
                    return false;
                }
                return true;
            };
            this.onUserDefinedFunctionsKeyDown = function (source, event) {
                if (event.key === "ArrowRight" && !_this.isUserDefinedFunctionsExpanded()) {
                    _this.expandUserDefinedFunctions();
                    return false;
                }
                if (event.key === "ArrowDown" && !_this.isUserDefinedFunctionsExpanded()) {
                    _this.expandUserDefinedFunctions();
                    return false;
                }
                if (event.key === "ArrowLeft" && _this.isUserDefinedFunctionsExpanded()) {
                    _this.collapseUserDefinedFunctions();
                    return false;
                }
                return true;
            };
            this.onUserDefinedFunctionsKeyPress = function (source, event) {
                if (event.keyCode === Constants.KeyCodes.Space || event.keyCode === Constants.KeyCodes.Enter) {
                    _this.expandCollapseUserDefinedFunctions();
                    return false;
                }
                return true;
            };
            this.onTriggersKeyDown = function (source, event) {
                if (event.key === "ArrowRight" && !_this.isTriggersExpanded()) {
                    _this.expandTriggers();
                    return false;
                }
                if (event.key === "ArrowDown" && !_this.isTriggersExpanded()) {
                    _this.expandTriggers();
                    return false;
                }
                if (event.key === "ArrowLeft" && _this.isTriggersExpanded()) {
                    _this.collapseTriggers();
                    return false;
                }
                return true;
            };
            this.onTriggersKeyPress = function (source, event) {
                if (event.keyCode === Constants.KeyCodes.Space || event.keyCode === Constants.KeyCodes.Enter) {
                    _this.expandCollapseTriggers();
                    return false;
                }
                return true;
            };
            this._createGraphTab = function (title) {
                var startKey = TelemetryProcessor_1.default.traceStart(TelemetryConstants_1.Action.Tab, {
                    databaseAccountName: _this.container.databaseAccount().name,
                    databaseName: _this.database.id(),
                    collectionName: _this.id(),
                    defaultExperience: _this.container.defaultExperience(),
                    dataExplorerArea: Constants.Areas.Tab,
                    tabTitle: title
                });
                // TODO where does the success/failure trace for this tab go?  
                return new GraphTab({
                    account: DocumentDB.RequestHandler._databaseAccount && DocumentDB.RequestHandler._databaseAccount() || {},
                    tabKind: ViewModels.CollectionTabKind.Graph,
                    node: _this,
                    title: title,
                    tabPath: "",
                    documentClientUtility: _this.container.documentClientUtility,
                    isRunningOnDaytona: false,
                    collection: _this,
                    selfLink: _this.self,
                    masterKey: DocumentDB.RequestHandler._masterKey && DocumentDB.RequestHandler._masterKey() || "",
                    collectionPartitionKeyProperty: _this.partitionKeyProperty,
                    hashLocation: Constants.HashRoutePrefixes.collectionsWithIds(_this.database.id(), _this.id()) + "/graphs",
                    collectionId: _this.id(),
                    isActive: ko.observable(false),
                    databaseId: _this.database.id(),
                    isTabsContentExpanded: _this.container.isTabsContentExpanded,
                    onLoadStartKey: startKey
                });
            };
            this.onMongoDBDocumentsClick = function () {
                _this.container.selectedNode(_this);
                _this.selectedSubnodeKind(ViewModels.CollectionTabKind.Documents);
                TelemetryProcessor_1.default.trace(TelemetryConstants_1.Action.SelectItem, TelemetryConstants_1.ActionModifiers.Mark, {
                    description: "Documents node",
                    databaseAccountName: _this.container.databaseAccount().name,
                    defaultExperience: _this.container.defaultExperience(),
                    dataExplorerArea: Constants.Areas.ResourceTree
                });
                // create documents tab if not created yet
                var openedTabs = _this.container.openedTabs();
                var documentsTab = openedTabs
                    .filter(function (tab) { return tab.collection && tab.collection && tab.collection.rid === _this.rid; })
                    .filter(function (tab) { return tab.tabKind === ViewModels.CollectionTabKind.Documents; })[0];
                if (!documentsTab) {
                    var startKey = TelemetryProcessor_1.default.traceStart(TelemetryConstants_1.Action.Tab, {
                        databaseAccountName: _this.container.databaseAccount().name,
                        databaseName: _this.database.id(),
                        collectionName: _this.id(),
                        defaultExperience: _this.container.defaultExperience(),
                        dataExplorerArea: Constants.Areas.Tab,
                        tabTitle: "Mongo Documents"
                    });
                    _this.documentIds([]);
                    documentsTab = new MongoDocumentsTab({
                        partitionKey: _this.partitionKey,
                        documentIds: _this.documentIds,
                        tabKind: ViewModels.CollectionTabKind.Documents,
                        title: "Mongo Documents",
                        tabPath: "",
                        documentClientUtility: _this.container.documentClientUtility,
                        collection: _this,
                        isRunningOnDaytona: false,
                        node: _this,
                        selfLink: _this.self,
                        hashLocation: Constants.HashRoutePrefixes.collectionsWithIds(_this.database.id(), _this.id()) + "/mongoDocuments",
                        isActive: ko.observable(false),
                        onLoadStartKey: startKey
                    });
                    _this.container.openedTabs.push(documentsTab);
                }
                // Activate
                documentsTab.onTabClick();
            };
            this.uploadFiles = function (fileList) {
                var deferred = Q.defer();
                var uploadPromises = [];
                var inProgressNotificationId = "";
                if (!fileList || fileList.length === 0) {
                    return Q.reject("No files specified");
                }
                var currentUrlWithoutQueryParamsAndHashRoute = window.location.protocol + "//" + window.location.host + window.location.pathname;
                var uploaderUrl = currentUrlWithoutQueryParamsAndHashRoute.replace(/\/[^\/]*$/, '/workers/libs/DocumentUploader.js');
                var clientSDKUrl = currentUrlWithoutQueryParamsAndHashRoute.replace(/\/[^\/]*$/, '/externals/documentdbclient-1.14.0.js');
                var documentUploader = new Worker(uploaderUrl);
                documentUploader.onmessage = function (event) {
                    var numSuccessful = event.data.numUploadsSuccessful;
                    var numFailed = event.data.numUploadsFailed;
                    var runtimeError = event.data.runtimeError;
                    var uploadDetails = event.data.uploadDetails;
                    NotificationConsoleUtils_1.NotificationConsoleUtils.clearInProgressMessageWithId(inProgressNotificationId);
                    documentUploader.terminate();
                    if (!!runtimeError) {
                        deferred.reject(runtimeError);
                    }
                    else if (numSuccessful === 0) { // all uploads failed
                        NotificationConsoleUtils_1.NotificationConsoleUtils.logConsoleMessage(NotificationConsole_1.ConsoleDataType.Error, "Failed to upload all documents to collection " + _this.id());
                    }
                    else if (numFailed > 0) {
                        NotificationConsoleUtils_1.NotificationConsoleUtils.logConsoleMessage(NotificationConsole_1.ConsoleDataType.Error, "Failed to upload " + numFailed + " of " + (numSuccessful + numFailed) + " documents to collection " + _this.id());
                    }
                    else {
                        NotificationConsoleUtils_1.NotificationConsoleUtils.logConsoleMessage(NotificationConsole_1.ConsoleDataType.Info, "Successfully uploaded all " + numSuccessful + " documents to collection " + _this.id());
                    }
                    _this._logUploadDetailsInConsole(uploadDetails);
                    deferred.resolve(uploadDetails);
                };
                documentUploader.onerror = function (event) {
                    documentUploader.terminate();
                    deferred.reject(event.error);
                };
                var DocumentDB = window.DocumentDB;
                var platformType = PlatformType_1.PlatformType[window.dataExplorerPlatform];
                var initialAuthToken = { authorization: "" };
                initialAuthToken[Constants.HttpHeaders.guestAccessToken] = undefined;
                var uploaderMessage = {
                    files: fileList,
                    documentClientParams: {
                        fileDownloadUrl: clientSDKUrl,
                        databaseAccount: _this.container.databaseAccount(),
                        requestTimeoutMs: Constants.ClientDefaults.requestTimeoutMs,
                        accountInfo: {
                            databaseAccount: DocumentDB.RequestHandler._databaseAccount && DocumentDB.RequestHandler._databaseAccount(),
                            subscriptionId: DocumentDB.RequestHandler._subscriptionId && DocumentDB.RequestHandler._subscriptionId(),
                            resourceGroup: DocumentDB.RequestHandler._resourceGroup && DocumentDB.RequestHandler._resourceGroup()
                        },
                        selfLink: _this.self,
                        platformType: platformType,
                        authType: window.authType,
                        apiKind: DefaultExperienceUtility_1.DefaultExperienceUtility.getApiKindFromDefaultExperience(_this.container && _this.container.defaultExperience()),
                        runtimeEndpoint: "",
                        authTokenInfo: [initialAuthToken]
                    }
                };
                // TODO: Refactor this block (253530)
                if (platformType === PlatformType_1.PlatformType[PlatformType_1.PlatformType.Hosted]) {
                    uploaderMessage.documentClientParams.runtimeEndpoint = HostedAuthorization.extensionEndpoint;
                }
                else if (platformType === PlatformType_1.PlatformType[PlatformType_1.PlatformType.Portal]) {
                    uploaderMessage.documentClientParams.runtimeEndpoint = _this.container.extensionEndpoint() || "";
                }
                _this._fetchAuthTokenForPlatform(platformType).then(function (authTokenInfo) {
                    uploaderMessage.documentClientParams.authTokenInfo = authTokenInfo;
                    documentUploader.postMessage(uploaderMessage);
                    inProgressNotificationId = NotificationConsoleUtils_1.NotificationConsoleUtils.logConsoleMessage(NotificationConsole_1.ConsoleDataType.InProgress, "Uploading and creating documents in collection " + _this.id());
                }, function (error) {
                    documentUploader.terminate();
                    NotificationConsoleUtils_1.NotificationConsoleUtils.logConsoleMessage(NotificationConsole_1.ConsoleDataType.Error, "Failed to get authorization token from server: " + JSON.stringify(error));
                    deferred.reject(error);
                });
                return deferred.promise;
            };
            this.nodeKind = "Collection";
            this.container = container;
            this.self = data._self;
            this.rid = data._rid;
            this.database = database;
            this.rawDataModel = data;
            this.partitionKey = data.partitionKey;
            this.id = ko.observable(data.id);
            this.defaultTtl = ko.observable(data.defaultTtl);
            this.indexingPolicy = ko.observable(data.indexingPolicy);
            this.quotaInfo = ko.observable(quotaInfo);
            this.offer = ko.observable(offer);
            this.conflictResolutionPolicy = ko.observable(data.conflictResolutionPolicy);
            // TODO fix this to only replace non-excaped single quotes
            this.partitionKeyProperty = this.partitionKey && this.partitionKey.paths && this.partitionKey.paths.length && this.partitionKey.paths.length > 0 && this.partitionKey.paths[0].replace(/[/]+/g, ".").substr(1).replace(/[']+/g, '') || null;
            this.partitionKeyPropertyHeader = this.partitionKey && this.partitionKey.paths && this.partitionKey.paths.length > 0 && this.partitionKey.paths[0] || null;
            // TODO #10738269 : Add this logic in a derived class for Mongo
            if (!!container.isPreferredApiMongoDB() && this.partitionKeyProperty && this.partitionKeyProperty.indexOf('$v') > -1) {
                // From $v.shard.$v.key.$v > shard.key
                this.partitionKeyProperty = this.partitionKeyProperty.replace(/.\$v/g, "").replace(/\$v./g, "");
                this.partitionKeyPropertyHeader = '/' + this.partitionKeyProperty;
            }
            this.documentIds = ko.observableArray([]);
            this.isCollectionExpanded = ko.observable(false);
            this.selectedSubnodeKind = ko.observable();
            this.focusedSubnodeKind = ko.observable();
            this.documentsFocused = ko.observable();
            this.documentsFocused.subscribe(function (focus) {
                console.log("Focus set on Documents: " + focus);
                _this.focusedSubnodeKind(ViewModels.CollectionTabKind.Documents);
            });
            this.settingsFocused = ko.observable(false);
            this.settingsFocused.subscribe(function (focus) {
                _this.focusedSubnodeKind(ViewModels.CollectionTabKind.Settings);
            });
            this.storedProceduresFocused = ko.observable(false);
            this.storedProceduresFocused.subscribe(function (focus) {
                _this.focusedSubnodeKind(ViewModels.CollectionTabKind.StoredProcedures);
            });
            this.userDefinedFunctionsFocused = ko.observable(false);
            this.userDefinedFunctionsFocused.subscribe(function (focus) {
                _this.focusedSubnodeKind(ViewModels.CollectionTabKind.UserDefinedFunctions);
            });
            this.triggersFocused = ko.observable(false);
            this.triggersFocused.subscribe(function (focus) {
                _this.focusedSubnodeKind(ViewModels.CollectionTabKind.Triggers);
            });
            this.children = ko.observableArray([]);
            this.storedProcedures = ko.computed(function () {
                return _this.children().filter(function (node) { return node.nodeKind === "StoredProcedure"; }).map(function (node) { return node; });
            });
            this.userDefinedFunctions = ko.computed(function () {
                return _this.children().filter(function (node) { return node.nodeKind === "UserDefinedFunction"; }).map(function (node) { return node; });
            });
            this.triggers = ko.computed(function () {
                return _this.children().filter(function (node) { return node.nodeKind === "Trigger"; }).map(function (node) { return node; });
            });
            this.showStoredProcedures = ko.observable(!container.isPreferredApiCassandra());
            this.showTriggers = ko.observable(!container.isPreferredApiCassandra());
            this.showUserDefinedFunctions = ko.observable(!container.isPreferredApiCassandra());
            this.showConflicts = ko.observable(!!data.conflictResolutionPolicy);
            this.isStoredProceduresExpanded = ko.observable(false);
            this.isUserDefinedFunctionsExpanded = ko.observable(false);
            this.isTriggersExpanded = ko.observable(false);
            this.contextMenu = new ContextMenu(this.container, this.rid);
            this.contextMenu.options(ContextMenuButtonFactory_1.ContextMenuButtonFactory.createCollectionContextMenuButton(container));
            this.documentsContextMenu = new ContextMenu(this.container, this.rid + "/documents");
        }
        Collection.prototype.expandCollapseCollection = function () {
            this.container.selectedNode(this);
            TelemetryProcessor_1.default.trace(TelemetryConstants_1.Action.SelectItem, TelemetryConstants_1.ActionModifiers.Mark, {
                description: "Collection node",
                databaseAccountName: this.container.databaseAccount().name,
                defaultExperience: this.container.defaultExperience(),
                dataExplorerArea: Constants.Areas.ResourceTree
            });
            if (this.isCollectionExpanded()) {
                this.collapseCollection();
            }
            else {
                this.expandCollection();
            }
            this.refreshActiveTab();
        };
        Collection.prototype.collapseCollection = function () {
            if (!this.isCollectionExpanded()) {
                return;
            }
            this.isCollectionExpanded(false);
            TelemetryProcessor_1.default.trace(TelemetryConstants_1.Action.CollapseTreeNode, TelemetryConstants_1.ActionModifiers.Mark, {
                description: "Collection node",
                databaseAccountName: this.container.databaseAccount().name,
                defaultExperience: this.container.defaultExperience(),
                dataExplorerArea: Constants.Areas.ResourceTree
            });
        };
        Collection.prototype.expandCollection = function () {
            if (this.isCollectionExpanded()) {
                return Q();
            }
            var loadSprocPromise = this.loadStoredProcedures();
            var loadUDFPromise = this.loadUserDefinedFunctions();
            var loadTriggersPromise = this.loadTriggers();
            this.isCollectionExpanded(true);
            TelemetryProcessor_1.default.trace(TelemetryConstants_1.Action.ExpandTreeNode, TelemetryConstants_1.ActionModifiers.Mark, {
                description: "Collection node",
                databaseAccountName: this.container.databaseAccount().name,
                defaultExperience: this.container.defaultExperience(),
                dataExplorerArea: Constants.Areas.ResourceTree
            });
            return Q.all([loadSprocPromise, loadUDFPromise, loadTriggersPromise]);
        };
        Collection.prototype.onDocumentDBDocumentsClick = function () {
            var _this = this;
            this.container.selectedNode(this);
            this.selectedSubnodeKind(ViewModels.CollectionTabKind.Documents);
            TelemetryProcessor_1.default.trace(TelemetryConstants_1.Action.SelectItem, TelemetryConstants_1.ActionModifiers.Mark, {
                description: "Documents node",
                databaseAccountName: this.container.databaseAccount().name,
                defaultExperience: this.container.defaultExperience(),
                dataExplorerArea: Constants.Areas.ResourceTree
            });
            // create documents tab if not created yet
            var openedTabs = this.container.openedTabs();
            var documentsTab = openedTabs
                .filter(function (tab) { return tab.collection && tab.collection.rid === _this.rid; })
                .filter(function (tab) { return tab.tabKind === ViewModels.CollectionTabKind.Documents; })[0];
            if (!documentsTab) {
                var startKey = TelemetryProcessor_1.default.traceStart(TelemetryConstants_1.Action.Tab, {
                    databaseAccountName: this.container.databaseAccount().name,
                    databaseName: this.database.id(),
                    collectionName: this.id(),
                    defaultExperience: this.container.defaultExperience(),
                    dataExplorerArea: Constants.Areas.Tab,
                    tabTitle: "Documents"
                });
                this.documentIds([]);
                documentsTab = new DocumentsTab({
                    partitionKey: this.partitionKey,
                    documentIds: ko.observableArray([]),
                    tabKind: ViewModels.CollectionTabKind.Documents,
                    title: "Documents",
                    documentClientUtility: this.container.documentClientUtility,
                    isRunningOnDaytona: false,
                    selfLink: this.self,
                    isActive: ko.observable(false),
                    collection: this,
                    node: this,
                    tabPath: this.database.id() + ">" + this.id() + ">Documents",
                    hashLocation: Constants.HashRoutePrefixes.collectionsWithIds(this.database.id(), this.id()) + "/documents",
                    onLoadStartKey: startKey
                });
                this.container.openedTabs.push(documentsTab);
            }
            // Activate
            documentsTab.onTabClick();
        };
        Collection.prototype.onConflictsClick = function () {
            var _this = this;
            this.container.selectedNode(this);
            this.selectedSubnodeKind(ViewModels.CollectionTabKind.Conflicts);
            TelemetryProcessor_1.default.trace(TelemetryConstants_1.Action.SelectItem, TelemetryConstants_1.ActionModifiers.Mark, {
                description: "Conflicts node",
                databaseAccountName: this.container.databaseAccount().name,
                defaultExperience: this.container.defaultExperience(),
                dataExplorerArea: Constants.Areas.ResourceTree
            });
            // create documents tab if not created yet
            var openedTabs = this.container.openedTabs();
            var conflictsTab = openedTabs
                .filter(function (tab) { return tab.collection && tab.collection.rid === _this.rid; })
                .filter(function (tab) { return tab.tabKind === ViewModels.CollectionTabKind.Conflicts; })[0];
            if (!conflictsTab) {
                var startKey = TelemetryProcessor_1.default.traceStart(TelemetryConstants_1.Action.Tab, {
                    databaseAccountName: this.container.databaseAccount().name,
                    databaseName: this.database.id(),
                    collectionName: this.id(),
                    defaultExperience: this.container.defaultExperience(),
                    dataExplorerArea: Constants.Areas.Tab,
                    tabTitle: "Conflicts"
                });
                this.documentIds([]);
                conflictsTab = new ConflictsTab_1.ConflictsTab({
                    partitionKey: this.partitionKey,
                    conflictIds: ko.observableArray([]),
                    tabKind: ViewModels.CollectionTabKind.Conflicts,
                    title: "Conflicts",
                    documentClientUtility: this.container.documentClientUtility,
                    isRunningOnDaytona: false,
                    selfLink: this.self,
                    isActive: ko.observable(false),
                    collection: this,
                    node: this,
                    tabPath: this.database.id() + ">" + this.id() + ">Conflicts",
                    hashLocation: Constants.HashRoutePrefixes.collectionsWithIds(this.database.id(), this.id()) + "/conflicts",
                    onLoadStartKey: startKey
                });
                this.container.openedTabs.push(conflictsTab);
            }
            // Activate
            conflictsTab.onTabClick();
        };
        Collection.prototype.onTableEntitiesClick = function () {
            var _this = this;
            this.container.selectedNode(this);
            this.selectedSubnodeKind(ViewModels.CollectionTabKind.QueryTables);
            TelemetryProcessor_1.default.trace(TelemetryConstants_1.Action.SelectItem, TelemetryConstants_1.ActionModifiers.Mark, {
                description: "Entities node",
                databaseAccountName: this.container.databaseAccount().name,
                defaultExperience: this.container.defaultExperience(),
                dataExplorerArea: Constants.Areas.ResourceTree
            });
            if (this.container.isPreferredApiCassandra() && !this.cassandraKeys) {
                this.container.tableDataClient.getTableKeys(this).then(function (keys) {
                    _this.cassandraKeys = keys;
                });
            }
            // create entities tab if not created yet
            var openedTabs = this.container.openedTabs();
            var documentsTab = openedTabs
                .filter(function (tab) { return tab.collection && tab.collection.rid === _this.rid; })
                .filter(function (tab) { return tab.tabKind === ViewModels.CollectionTabKind.QueryTables; })[0];
            if (!documentsTab) {
                this.documentIds([]);
                var title = "Entities";
                if (this.container.isPreferredApiCassandra()) {
                    title = "Rows";
                }
                var startKey = TelemetryProcessor_1.default.traceStart(TelemetryConstants_1.Action.Tab, {
                    databaseAccountName: this.container.databaseAccount().name,
                    databaseName: this.database.id(),
                    collectionName: this.id(),
                    defaultExperience: this.container.defaultExperience(),
                    dataExplorerArea: Constants.Areas.Tab,
                    tabTitle: title
                });
                documentsTab = new QueryTablesTab_1.default({
                    tabKind: ViewModels.CollectionTabKind.QueryTables,
                    title: title,
                    tabPath: "",
                    documentClientUtility: this.container.documentClientUtility,
                    collection: this,
                    isRunningOnDaytona: false,
                    node: this,
                    selfLink: this.self,
                    hashLocation: Constants.HashRoutePrefixes.collectionsWithIds(this.database.id(), this.id()) + "/entities",
                    isActive: ko.observable(false),
                    onLoadStartKey: startKey
                });
                this.container.openedTabs.push(documentsTab);
            }
            // Activate
            documentsTab.onTabClick();
        };
        Collection.prototype.onGraphDocumentsClick = function () {
            var _this = this;
            this.container.selectedNode(this);
            this.selectedSubnodeKind(ViewModels.CollectionTabKind.Graph);
            TelemetryProcessor_1.default.trace(TelemetryConstants_1.Action.SelectItem, TelemetryConstants_1.ActionModifiers.Mark, {
                description: "Documents node",
                databaseAccountName: this.container.databaseAccount().name,
                defaultExperience: this.container.defaultExperience(),
                dataExplorerArea: Constants.Areas.ResourceTree
            });
            // create documents tab if not created yet
            var openedTabs = this.container.openedTabs();
            var documentsTab = openedTabs
                .filter(function (tab) { return tab.collection && tab.collection.rid === _this.rid; })
                .filter(function (tab) { return tab.tabKind === ViewModels.CollectionTabKind.Graph; })[0];
            if (!documentsTab) {
                this.documentIds([]);
                documentsTab = this._createGraphTab("Graph");
                this.container.openedTabs.push(documentsTab);
            }
            // Activate
            documentsTab.onTabClick();
        };
        Collection.prototype.onSettingsClick = function () {
            var _this = this;
            this.container.selectedNode(this);
            this.selectedSubnodeKind(ViewModels.CollectionTabKind.Settings);
            TelemetryProcessor_1.default.trace(TelemetryConstants_1.Action.SelectItem, TelemetryConstants_1.ActionModifiers.Mark, {
                description: "Settings node",
                databaseAccountName: this.container.databaseAccount().name,
                defaultExperience: this.container.defaultExperience(),
                dataExplorerArea: Constants.Areas.ResourceTree
            });
            // create settings tab if not created yet
            var openedTabs = this.container.openedTabs();
            var settingsTab = openedTabs
                .filter(function (tab) { return tab.collection && tab.collection.rid === _this.rid; })
                .filter(function (tab) { return tab.tabKind === ViewModels.CollectionTabKind.Settings; })[0];
            var tabTitle = "Scale & Settings";
            var pendingNotificationsPromise = this._getPendingThroughputSplitNotification();
            if (!settingsTab) {
                var startKey_1 = TelemetryProcessor_1.default.traceStart(TelemetryConstants_1.Action.Tab, {
                    databaseAccountName: this.container.databaseAccount().name,
                    databaseName: this.database.id(),
                    collectionName: this.id(),
                    defaultExperience: this.container.defaultExperience(),
                    dataExplorerArea: Constants.Areas.Tab,
                    tabTitle: tabTitle
                });
                Q.all([pendingNotificationsPromise, this.readSettings()]).then(function (data) {
                    var pendingNotification = data && data[0];
                    settingsTab = new SettingsTab({
                        tabKind: ViewModels.CollectionTabKind.Settings,
                        title: !_this.offer() ? "Settings" : "Scale & Settings",
                        tabPath: "",
                        documentClientUtility: _this.container.documentClientUtility,
                        collection: _this,
                        node: _this,
                        isRunningOnDaytona: false,
                        selfLink: _this.self,
                        hashLocation: Constants.HashRoutePrefixes.collectionsWithIds(_this.database.id(), _this.id()) + "/settings",
                        isActive: ko.observable(false),
                        onLoadStartKey: startKey_1
                    });
                    settingsTab.pendingNotification(pendingNotification);
                    _this.container.openedTabs.push(settingsTab);
                    settingsTab.onTabClick(); // Activate
                }, function (error) {
                    TelemetryProcessor_1.default.traceFailure(TelemetryConstants_1.Action.Tab, {
                        databaseAccountName: _this.container.databaseAccount().name,
                        databaseName: _this.database.id(),
                        collectionName: _this.id(),
                        defaultExperience: _this.container.defaultExperience(),
                        dataExplorerArea: Constants.Areas.Tab,
                        tabTitle: tabTitle,
                        error: error
                    }, startKey_1);
                    NotificationConsoleUtils_1.NotificationConsoleUtils.logConsoleMessage(NotificationConsole_1.ConsoleDataType.Error, "Error while fetching collection settings for collection " + _this.id() + ": " + JSON.stringify(error));
                    throw error;
                });
            }
            else {
                pendingNotificationsPromise.then(function (pendingNotification) {
                    settingsTab.pendingNotification(pendingNotification);
                    settingsTab.onTabClick();
                }, function (error) {
                    settingsTab.pendingNotification(undefined);
                    settingsTab.onTabClick();
                });
            }
        };
        Collection.prototype.readSettings = function () {
            var _this = this;
            var deferred = Q.defer();
            this.container.isRefreshingExplorer(true);
            var collectionDataModel = {
                id: this.id(),
                _rid: this.rid,
                _self: this.self,
                defaultTtl: this.defaultTtl(),
                indexingPolicy: this.indexingPolicy(),
                partitionKey: this.partitionKey
            };
            var startKey = TelemetryProcessor_1.default.traceStart(TelemetryConstants_1.Action.LoadOffers, {
                databaseAccountName: this.container.databaseAccount().name,
                defaultExperience: this.container.defaultExperience()
            });
            // TODO: Use the collection entity cache to get quota info
            var quotaInfoPromise = this.container.documentClientUtility.readCollectionQuotaInfo(collectionDataModel, null /** options **/);
            var offerInfoPromise = this.container.documentClientUtility.readOffers(null /** options **/);
            Q.all([quotaInfoPromise, offerInfoPromise]).then(function () {
                _this.container.isRefreshingExplorer(false);
                var quotaInfoWithUniqueKeyPolicy = quotaInfoPromise.valueOf();
                _this.uniqueKeyPolicy = quotaInfoWithUniqueKeyPolicy.uniqueKeyPolicy;
                var quotaInfo = _.omit(quotaInfoWithUniqueKeyPolicy, "uniqueKeyPolicy");
                var collectionOffer = _this._getOfferForCollection(offerInfoPromise.valueOf(), collectionDataModel);
                if (_this.database.isDatabaseShared() && !collectionOffer) {
                    _this.quotaInfo(quotaInfo);
                    TelemetryProcessor_1.default.traceSuccess(TelemetryConstants_1.Action.LoadOffers, {
                        databaseAccountName: _this.container.databaseAccount().name,
                        defaultExperience: _this.container.defaultExperience()
                    }, startKey);
                    deferred.resolve();
                    return;
                }
                _this.container.documentClientUtility.readOffer(collectionOffer, null /* options */).then(function (offerDetail) {
                    if (OfferUtils_1.OfferUtils.isNotOfferV1(collectionOffer)) {
                        var offerThroughputInfo = {
                            minimumRUForCollection: offerDetail.content && offerDetail.content.collectionThroughputInfo && offerDetail.content.collectionThroughputInfo.minimumRUForCollection,
                            numPhysicalPartitions: offerDetail.content && offerDetail.content.collectionThroughputInfo && offerDetail.content.collectionThroughputInfo.numPhysicalPartitions
                        };
                        collectionOffer.content.collectionThroughputInfo = offerThroughputInfo;
                    }
                    collectionOffer.headers = offerDetail.headers;
                    _this.offer(collectionOffer);
                    _this.offer.valueHasMutated();
                    _this.quotaInfo(quotaInfo);
                    TelemetryProcessor_1.default.traceSuccess(TelemetryConstants_1.Action.LoadOffers, {
                        databaseAccountName: _this.container.databaseAccount().name,
                        defaultExperience: _this.container.defaultExperience(),
                        offerVersion: collectionOffer && collectionOffer.offerVersion
                    }, startKey);
                    deferred.resolve();
                });
            }, function (error) {
                _this.container.isRefreshingExplorer(false);
                deferred.reject(error);
                TelemetryProcessor_1.default.traceFailure(TelemetryConstants_1.Action.LoadOffers, {
                    databaseAccountName: _this.container.databaseAccount().name,
                    defaultExperience: _this.container.defaultExperience()
                }, startKey);
            });
            return deferred.promise;
        };
        Collection.prototype.onNewQueryClick = function (source, event, queryText) {
            var collection = source.collection || source;
            var explorer = source.container;
            var openedTabs = explorer.openedTabs();
            var id = openedTabs.filter(function (t) { return t.tabKind === ViewModels.CollectionTabKind.Query; }).length + 1;
            var title = "Query " + id;
            var startKey = TelemetryProcessor_1.default.traceStart(TelemetryConstants_1.Action.Tab, {
                databaseAccountName: this.container.databaseAccount().name,
                databaseName: this.database.id(),
                collectionName: this.id(),
                defaultExperience: this.container.defaultExperience(),
                dataExplorerArea: Constants.Areas.Tab,
                tabTitle: title
            });
            var queryTab = new QueryTab({
                tabKind: ViewModels.CollectionTabKind.Query,
                title: title,
                tabPath: "",
                documentClientUtility: this.container.documentClientUtility,
                collection: this,
                node: this,
                isRunningOnDaytona: false,
                selfLink: this.self,
                hashLocation: Constants.HashRoutePrefixes.collectionsWithIds(this.database.id(), this.id()) + "/query",
                isActive: ko.observable(false),
                queryText: queryText,
                partitionKey: collection.partitionKey,
                onLoadStartKey: startKey
            });
            this.container.openedTabs.push(queryTab);
            // Activate
            queryTab.onTabClick();
            // Hide Context Menu (if necessary)
            collection.contextMenu.hide(this, null);
        };
        Collection.prototype.onNewMongoQueryClick = function (source, event, queryText) {
            var collection = source.collection || source;
            var explorer = source.container;
            var openedTabs = explorer.openedTabs();
            var id = openedTabs.filter(function (t) { return t.tabKind === ViewModels.CollectionTabKind.Query; }).length + 1;
            var title = "Query " + id;
            var startKey = TelemetryProcessor_1.default.traceStart(TelemetryConstants_1.Action.Tab, {
                databaseAccountName: this.container.databaseAccount().name,
                databaseName: this.database.id(),
                collectionName: this.id(),
                defaultExperience: this.container.defaultExperience(),
                dataExplorerArea: Constants.Areas.Tab,
                tabTitle: title
            });
            var queryTab = new MongoQueryTab({
                tabKind: ViewModels.CollectionTabKind.Query,
                title: title,
                tabPath: "",
                documentClientUtility: this.container.documentClientUtility,
                collection: this,
                node: this,
                isRunningOnDaytona: false,
                selfLink: this.self,
                hashLocation: Constants.HashRoutePrefixes.collectionsWithIds(this.database.id(), this.id()) + "/mongoQuery",
                isActive: ko.observable(false),
                partitionKey: collection.partitionKey,
                onLoadStartKey: startKey
            });
            this.container.openedTabs.push(queryTab);
            // Activate
            queryTab.onTabClick();
            // Hide Context Menu (if necessary)
            collection.contextMenu.hide(this, null);
        };
        Collection.prototype.onNewGraphClick = function () {
            var id = this.container.openedTabs().filter(function (t) { return t.tabKind === ViewModels.CollectionTabKind.Graph; }).length + 1;
            var graphTab = this._createGraphTab("Graph Query " + id);
            this.container.openedTabs.push(graphTab);
            // Activate
            graphTab.onTabClick();
            // Hide Context Menu (if necessary)
            this.contextMenu.hide(this, null);
        };
        Collection.prototype.onNewMongoShellClick = function () {
            var id = this.container.openedTabs().filter(function (t) { return t.tabKind === ViewModels.CollectionTabKind.MongoShell; }).length + 1;
            var mongoShellTab = new MongoShellTab({
                tabKind: ViewModels.CollectionTabKind.MongoShell,
                title: "Shell " + id,
                tabPath: "",
                documentClientUtility: this.container.documentClientUtility,
                collection: this,
                node: this,
                isRunningOnDaytona: false,
                hashLocation: Constants.HashRoutePrefixes.collectionsWithIds(this.database.id(), this.id()) + "/mongoShell",
                selfLink: this.self,
                isActive: ko.observable(false)
            });
            this.container.openedTabs.push(mongoShellTab);
            // Activate
            mongoShellTab.onTabClick();
            // Hide Context Menu (if necessary)
            this.contextMenu.hide(this, null);
        };
        Collection.prototype.onNewStoredProcedureClick = function (source, event) {
            StoredProcedure.create(source, event);
        };
        Collection.prototype.onNewUserDefinedFunctionClick = function (source, event) {
            UserDefinedFunction.create(source, event);
        };
        Collection.prototype.onNewTriggerClick = function (source, event) {
            Trigger.create(source, event);
        };
        Collection.prototype.createStoredProcedureNode = function (data) {
            var node = new StoredProcedure(this.container, this, data);
            this.container.selectedNode(node);
            this.children.push(node);
            return node;
        };
        Collection.prototype.createUserDefinedFunctionNode = function (data) {
            var node = new UserDefinedFunction(this.container, this, data);
            this.container.selectedNode(node);
            this.children.push(node);
            return node;
        };
        Collection.prototype.createTriggerNode = function (data) {
            var node = new Trigger(this.container, this, data);
            this.container.selectedNode(node);
            this.children.push(node);
            return node;
        };
        Collection.prototype.findStoredProcedureWithId = function (sprocId) {
            return _.find(this.storedProcedures(), function (storedProcedure) { return storedProcedure.id() === sprocId; });
        };
        Collection.prototype.findTriggerWithId = function (triggerId) {
            return _.find(this.triggers(), function (trigger) { return trigger.id() === triggerId; });
        };
        Collection.prototype.findUserDefinedFunctionWithId = function (userDefinedFunctionId) {
            return _.find(this.userDefinedFunctions(), function (userDefinedFunction) { return userDefinedFunction.id() === userDefinedFunctionId; });
        };
        Collection.prototype.expandCollapseStoredProcedures = function () {
            this.selectedSubnodeKind(ViewModels.CollectionTabKind.StoredProcedures);
            if (this.isStoredProceduresExpanded()) {
                this.collapseStoredProcedures();
            }
            else {
                this.expandStoredProcedures();
            }
            this.refreshActiveTab();
        };
        Collection.prototype.expandStoredProcedures = function () {
            if (this.isStoredProceduresExpanded()) {
                return;
            }
            this.isStoredProceduresExpanded(true);
            TelemetryProcessor_1.default.trace(TelemetryConstants_1.Action.ExpandTreeNode, TelemetryConstants_1.ActionModifiers.Mark, {
                description: "Stored procedures node",
                databaseAccountName: this.container.databaseAccount().name,
                defaultExperience: this.container.defaultExperience(),
                dataExplorerArea: Constants.Areas.ResourceTree
            });
        };
        Collection.prototype.collapseStoredProcedures = function () {
            if (!this.isStoredProceduresExpanded()) {
                return;
            }
            this.isStoredProceduresExpanded(false);
            TelemetryProcessor_1.default.trace(TelemetryConstants_1.Action.CollapseTreeNode, TelemetryConstants_1.ActionModifiers.Mark, {
                description: "Stored procedures node",
                databaseAccountName: this.container.databaseAccount().name,
                defaultExperience: this.container.defaultExperience(),
                dataExplorerArea: Constants.Areas.ResourceTree
            });
        };
        Collection.prototype.expandCollapseUserDefinedFunctions = function () {
            this.selectedSubnodeKind(ViewModels.CollectionTabKind.UserDefinedFunctions);
            if (this.isUserDefinedFunctionsExpanded()) {
                this.collapseUserDefinedFunctions();
            }
            else {
                this.expandUserDefinedFunctions();
            }
            this.refreshActiveTab();
        };
        Collection.prototype.expandUserDefinedFunctions = function () {
            if (this.isUserDefinedFunctionsExpanded()) {
                return;
            }
            this.isUserDefinedFunctionsExpanded(true);
            TelemetryProcessor_1.default.trace(TelemetryConstants_1.Action.ExpandTreeNode, TelemetryConstants_1.ActionModifiers.Mark, {
                description: "UDF node",
                databaseAccountName: this.container.databaseAccount().name,
                defaultExperience: this.container.defaultExperience(),
                dataExplorerArea: Constants.Areas.ResourceTree
            });
        };
        Collection.prototype.collapseUserDefinedFunctions = function () {
            if (!this.isUserDefinedFunctionsExpanded()) {
                return;
            }
            this.isUserDefinedFunctionsExpanded(false);
            TelemetryProcessor_1.default.trace(TelemetryConstants_1.Action.ExpandTreeNode, TelemetryConstants_1.ActionModifiers.Mark, {
                description: "UDF node",
                databaseAccountName: this.container.databaseAccount().name,
                defaultExperience: this.container.defaultExperience(),
                dataExplorerArea: Constants.Areas.ResourceTree
            });
        };
        Collection.prototype.expandCollapseTriggers = function () {
            this.selectedSubnodeKind(ViewModels.CollectionTabKind.Triggers);
            if (this.isTriggersExpanded()) {
                this.collapseTriggers();
            }
            else {
                this.expandTriggers();
            }
            this.refreshActiveTab();
        };
        Collection.prototype.expandTriggers = function () {
            if (this.isTriggersExpanded()) {
                return;
            }
            this.isTriggersExpanded(true);
            TelemetryProcessor_1.default.trace(TelemetryConstants_1.Action.ExpandTreeNode, TelemetryConstants_1.ActionModifiers.Mark, {
                description: "Triggers node",
                databaseAccountName: this.container.databaseAccount().name,
                defaultExperience: this.container.defaultExperience(),
                dataExplorerArea: Constants.Areas.ResourceTree
            });
        };
        Collection.prototype.collapseTriggers = function () {
            if (!this.isTriggersExpanded()) {
                return;
            }
            this.isTriggersExpanded(false);
            TelemetryProcessor_1.default.trace(TelemetryConstants_1.Action.CollapseTreeNode, TelemetryConstants_1.ActionModifiers.Mark, {
                description: "Triggers node",
                databaseAccountName: this.container.databaseAccount().name,
                defaultExperience: this.container.defaultExperience(),
                dataExplorerArea: Constants.Areas.ResourceTree
            });
        };
        Collection.prototype.loadStoredProcedures = function () {
            var _this = this;
            return this.container.documentClientUtility.readStoredProcedures(this, null /*options*/)
                .then(function (storedProcedures) {
                var storedProceduresNodes = storedProcedures.map(function (storedProcedure) { return new StoredProcedure(_this.container, _this, storedProcedure); });
                var otherNodes = _this.children().filter(function (node) { return node.nodeKind !== "StoredProcedure"; });
                var allNodes = otherNodes.concat(storedProceduresNodes);
                _this.children(allNodes);
            });
        };
        Collection.prototype.loadUserDefinedFunctions = function () {
            var _this = this;
            return this.container.documentClientUtility.readUserDefinedFunctions(this, null /*options*/)
                .then(function (userDefinedFunctions) {
                var userDefinedFunctionsNodes = userDefinedFunctions.map(function (udf) { return new UserDefinedFunction(_this.container, _this, udf); });
                var otherNodes = _this.children().filter(function (node) { return node.nodeKind !== "UserDefinedFunction"; });
                var allNodes = otherNodes.concat(userDefinedFunctionsNodes);
                _this.children(allNodes);
            });
        };
        Collection.prototype.loadTriggers = function () {
            var _this = this;
            return this.container.documentClientUtility.readTriggers(this, null /*options*/)
                .then(function (triggers) {
                var triggerNodes = triggers.map(function (trigger) { return new Trigger(_this.container, _this, trigger); });
                var otherNodes = _this.children().filter(function (node) { return node.nodeKind !== "Trigger"; });
                var allNodes = otherNodes.concat(triggerNodes);
                _this.children(allNodes);
            });
        };
        Collection.prototype.onDragOver = function (source, event) {
            event.originalEvent.stopPropagation();
            event.originalEvent.preventDefault();
        };
        Collection.prototype.onDrop = function (source, event) {
            event.originalEvent.stopPropagation();
            event.originalEvent.preventDefault();
            this.uploadFiles(event.originalEvent.dataTransfer.files);
        };
        Collection.prototype.isCollectionNodeSelected = function () {
            return this.isSubNodeSelected(ViewModels.CollectionTabKind.Query) || (!this.isCollectionExpanded() && this.container.selectedNode && this.container.selectedNode() && this.container.selectedNode().rid === this.rid && this.container.selectedNode().nodeKind === "Collection");
        };
        Collection.prototype.isSubNodeSelected = function (nodeKind) {
            return this.container.selectedNode && this.container.selectedNode() && this.container.selectedNode().rid === this.rid && this.selectedSubnodeKind() === nodeKind;
        };
        Collection.prototype.onDeleteCollectionContextMenuClick = function (source, event) {
            this._onContextMenuClick(source, event);
            this.container.deleteCollectionConfirmationPane.open();
        };
        Collection.prototype._fetchAuthTokenForPlatform = function (platformType) {
            var deferred = Q.defer();
            var authType = window.authType;
            if (platformType === PlatformType_1.PlatformType[PlatformType_1.PlatformType.Emulator]) {
                var readCollectionHeadersPromise = EmulatorAuthorization.AuthHeadersUtil.getForReadCollection(this.rid);
                var createDocumentHeadersPromise = EmulatorAuthorization.AuthHeadersUtil.getForSaveDocument(this.rid);
                Q.all([readCollectionHeadersPromise, createDocumentHeadersPromise]).then(function (authHeaders) {
                    var transformedHeaders = _.map(authHeaders, function (header) { return header; });
                    deferred.resolve(transformedHeaders);
                }, function (error) {
                    deferred.reject(error);
                });
            }
            else if (platformType === PlatformType_1.PlatformType[PlatformType_1.PlatformType.Hosted] && authType === AuthType_1.AuthType.AAD) {
                HostedAuthorization.getAuthorizationToken().then(function (authToken) {
                    var token = { authorization: authToken };
                    token[Constants.HttpHeaders.guestAccessToken] = undefined;
                    deferred.resolve([token]);
                }, function (error) {
                    deferred.reject(error);
                });
            }
            else if (platformType === PlatformType_1.PlatformType[PlatformType_1.PlatformType.Hosted] && authType === AuthType_1.AuthType.EncryptedToken) {
                if (DocumentDB.RequestHandler._accessToken) {
                    var token = { authorization: undefined };
                    token[Constants.HttpHeaders.guestAccessToken] = DocumentDB.RequestHandler._accessToken();
                    deferred.resolve([token]);
                }
                else {
                    deferred.reject("No access token found");
                }
            }
            else {
                var token = { authorization: (DocumentDB.RequestHandler._authorizationToken && DocumentDB.RequestHandler._authorizationToken()) || "" };
                token[Constants.HttpHeaders.guestAccessToken] = undefined;
                deferred.resolve([token]);
            }
            return deferred.promise;
        };
        Collection.prototype._getPendingThroughputSplitNotification = function () {
            var _this = this;
            if (!this.container) {
                return Q.resolve(undefined);
            }
            var deferred = Q.defer();
            this.container.notificationsClient.fetchNotifications().then(function (notifications) {
                if (!notifications || notifications.length === 0) {
                    deferred.resolve(undefined);
                    return;
                }
                var pendingNotification = _.find(notifications, function (notification) {
                    var throughputUpdateRegExp = new RegExp("Throughput update (.*) in progress");
                    return (notification.kind === "message") && (notification.collectionName === _this.id()) && notification.description && throughputUpdateRegExp.test(notification.description);
                });
                deferred.resolve(pendingNotification);
            }, function (error) {
                Logger_1.Logger.logError(JSON.stringify({
                    error: JSON.stringify(error),
                    accountName: _this.container && _this.container.databaseAccount(),
                    databaseName: _this.database.id(),
                    collectionName: _this.id(),
                }), "Settings tree node");
                deferred.resolve(undefined);
            });
            return deferred.promise;
        };
        Collection.prototype._logUploadDetailsInConsole = function (uploadDetails) {
            var _this = this;
            var uploadDetailsRecords = uploadDetails.data;
            var numFiles = uploadDetailsRecords.length;
            var stackTraceLimit = 100;
            var stackTraceCount = 0;
            var currentFileIndex = 0;
            while (stackTraceCount < stackTraceLimit && currentFileIndex < numFiles) {
                var errors = uploadDetailsRecords[currentFileIndex].errors;
                for (var i = 0; i < errors.length; i++) {
                    if (stackTraceCount >= stackTraceLimit) {
                        break;
                    }
                    NotificationConsoleUtils_1.NotificationConsoleUtils.logConsoleMessage(NotificationConsole_1.ConsoleDataType.Error, "Document creation error for collection " + this.id() + " - file " + uploadDetailsRecords[currentFileIndex].fileName + ": " + errors[i]);
                    stackTraceCount++;
                }
                currentFileIndex++;
            }
            uploadDetailsRecords.forEach(function (record) {
                var consoleDataType = record.numFailed > 0 ? NotificationConsole_1.ConsoleDataType.Error : NotificationConsole_1.ConsoleDataType.Info;
                NotificationConsoleUtils_1.NotificationConsoleUtils.logConsoleMessage(consoleDataType, "Document creation summary for collection " + _this.id() + " - file " + record.fileName + ": " + record.numSucceeded + " documents created, " + record.numFailed + " errors");
            });
        };
        Collection.prototype.refreshActiveTab = function () {
            var _this = this;
            // ensures that the tab selects/highlights the right node based on resource tree expand/collapse state
            var openedRelevantTabs = this.container.openedTabs().filter(function (tab) { return tab.collection && tab.collection.rid === _this.rid; });
            openedRelevantTabs.forEach(function (tab) {
                if (tab.isActive()) {
                    tab.onActivate();
                }
            });
        };
        Collection.prototype._onContextMenuClick = function (source, event) {
            this.container.selectedNode(this);
            this.contextMenu.hide(source, event);
        };
        Collection.prototype._getOfferForCollection = function (offers, collection) {
            return _.find(offers, function (offer) { return offer.resource.indexOf(collection._rid) >= 0; });
        };
        return Collection;
    }());
    return Collection;
});
Bg@K      [[?[kE   C    :https://cosmos.azure.com/built/Explorer/Tree/Collection.js?v=1.0.1 necko:classified 1 strongly-framed 1 security-info FnhllAKWRHGAlo+ESXykKAAAAAAAAAAAwAAAAAAAAEaphjojH6pBabDSgSnsfLHeAAQAAgAAAAAAAAAAAAAAAAAAAAAB4vFIJp5wRkeyPxAQ9RJGKPqbqVvKO0mKuIl8ec8o/uhmCjImkVxP+7sgiYWmMt8FvcOXmlQiTNWFiWlrbpbqgwAAAAAAAAOMMIIDiDCCAnCgAwIBAgIERTJgUjANBgkqhkiG9w0BAQsFADCBijEUMBIGA1UEBhMLUG9ydFN3aWdnZXIxFDASBgNVBAgTC1BvcnRTd2lnZ2VyMRQwEgYDVQQHEwtQb3J0U3dpZ2dlcjEUMBIGA1UEChMLUG9ydFN3aWdnZXIxFzAVBgNVBAsTDlBvcnRTd2lnZ2VyIENBMRcwFQYDVQQDEw5Qb3J0U3dpZ2dlciBDQTAeFw0xNDEwMjgxMzEyMTBaFw0zODEwMjgxMzEyMTBaMGAxFDASBgNVBAYTC1BvcnRTd2lnZ2VyMRQwEgYDVQQKEwtQb3J0U3dpZ2dlcjEXMBUGA1UECxMOUG9ydFN3aWdnZXIgQ0ExGTAXBgNVBAMTEGNvc21vcy5henVyZS5jb20wggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCKn7emKINsnWqPZ+C/VsqbQf/l4NsmIh34bXBR0xdNg9bfb+xcoghRlmbPjhZ/A26A2gJ6Rrg2d0GGMLpbqA8nTlRRGXEAD39321zk4ye09ElXClvqguGqdqOJpPQ05DPFD6wSOq+KVAEblE5bi+LMqBLipDERzgUe7xzeqVVk0i0ldh9yQOIk3YuzcBR9igSEuw5qladmMYvXKHYM9YZz0R7axMc8xAtadK7C9KfFPfEI5LS2nhmy4vBrTgFyYhfkEvKfmIj6HTX0ISFCAC2llcBLpEDcuiW76tAHp1pXDeWtSeaV36AeOctdleVgrbmsGs3fu6ppuRcWjEZUbjE3AgMBAAGjHzAdMBsGA1UdEQQUMBKCEGNvc21vcy5henVyZS5jb20wDQYJKoZIhvcNAQELBQADggEBABYikT6Y5YgJJ4IVJldlFDF5MKxp26YegXhvT8EmAbgr0yQBIlY2DtKEiHf7Q8wRoJ9y5Ajst1D7HmRba+XLjS6s3IHJ7gtuvc3fZj9MPKpbqSKRfHDB8bDOVIzmjBseg2BqckHTkcYak3b/pTWCTqKHM3LxKsDwN8F3HNQ2pY4d5ma2kR1EtWdTpRiIbir3QxJDcWVp8CgHONZcoMn33NNwnWWjAQMX6d8e1CPuBZi0t+myaYduCqPgKKox9qMXSubF6uifQkAJ5RdLZrZ2pghENA/4r1oz51wqEmpjPsStSUxRPwJ6wJrB4gwGtX7++ZHLjAaNrTSUCGwIOlAT4LnALwEDAAAAAAEBAAAAAA== request-method GET request-Accept-Encoding gzip, deflate, br response-head HTTP/1.1 200 OK
Content-Length: 63483
Content-Type: application/x-javascript
Last-Modified: Tue, 16 Oct 2018 01:58:30 GMT
Accept-Ranges: bytes
Etag: "06753bcf364d41:0"
Vary: Accept-Encoding
Server: Microsoft-IIS/10.0
X-Powered-By: ASP.NET
Date: Sun, 28 Oct 2018 18:39:28 GMT
 original-response-headers Content-Length: 63483
Content-Type: application/x-javascript
Last-Modified: Tue, 16 Oct 2018 01:58:30 GMT
Accept-Ranges: bytes
Etag: "06753bcf364d41:0"
Vary: Accept-Encoding
Server: Microsoft-IIS/10.0
X-Powered-By: ASP.NET
Date: Sun, 28 Oct 2018 18:39:28 GMT
Connection: close
 uncompressed-len 0 net-response-time-onstart 17124 net-response-time-onstop 17127   